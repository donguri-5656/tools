<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン HTML エディタ (安定版)</title>
    <style>
        /* --- CSS スタイル --- */
        body {
            display: flex;
            flex-direction: column;
            margin: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
        }

        .container {
            display: flex;
            flex-grow: 1;
        }

        .pane {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            overflow: auto;
        }

        #editor-pane {
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .parameter-input {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        .parameter-input label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .parameter-input input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
        }

        textarea {
            width: 100%;
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: none;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            margin-top: 5px;
        }

        /* プレビューエリアのiframeの親要素 */
        #preview-container {
            width: 100%;
            height: calc(100% - 30px); /* H2タグの高さを考慮 */
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        h2 {
            margin-top: 0;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <header>
        <h1>オンライン HTML エディタ (安定版)</h1>
    </header>

    <div class="container">
        <div class="pane" id="editor-pane">
            <div class="parameter-input">
                <label for="urlParameters">URLパラメーター (例: ?name=Taro&amp;age=30)</label>
                <input type="text" id="urlParameters" value="?name=Alice&amp;id=123" oninput="runCode()">
            </div>

            <h2>HTMLコード入力</h2>
            <textarea id="htmlCode" oninput="runCode()" placeholder="ここにHTML、CSS、JavaScriptを入力してください..."></textarea>
        </div>

        <div class="pane" id="preview-pane">
            <h2>プレビュー</h2>
            <div id="preview-container">
                </div>
        </div>
    </div>

    <script>
        /**
         * テキストエリアのコードを取得し、新しいiframeで実行結果を表示します。
         */
        function runCode() {
            const code = document.getElementById('htmlCode').value;
            const params = document.getElementById('urlParameters').value.trim();
            const previewContainer = document.getElementById('preview-container');

            // 1. 古い iframe を完全に削除し、新しい iframe を作成
            previewContainer.innerHTML = '';
            const newIframe = document.createElement('iframe');
            newIframe.id = 'preview';
            previewContainer.appendChild(newIframe);

            const iframeDoc = newIframe.contentWindow.document;

            iframeDoc.open();

            // 2. URLパラメーターのシミュレーションのためのJavaScriptコードを生成
            let simulatedUrl = '';
            let actualParams = params.startsWith('?') ? params : (params.length > 0 ? '?' + params : '');
            simulatedUrl = 'http://localhost/' + actualParams;
            
            // iframe内のJavaScriptで実行されるシミュレーションコード
            // window.simulatedSearchParams と window.getLocationSearch() を定義
            const simulationScript = `
                <script>
                    const _simulatedUrl = "${simulatedUrl}";
                    const _currentUrl = new URL(_simulatedUrl);
                    window.simulatedSearchParams = _currentUrl.searchParams;
                    
                    window.getLocationSearch = function() {
                        return "${actualParams}";
                    };
                <\/script>
            `;
            
            // 3. iframeにコードを書き込み
            iframeDoc.write(simulationScript + code);

            iframeDoc.close();
        }

        // ページロード時に実行される初期設定
        window.onload = function() {
            // パラメーターを読み取るサンプルコード（window.simulatedSearchParams を使用）
            const initialCode = `<!DOCTYPE html>
<html>
<head>
    <title>パラメーターテスト</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .result { color: darkgreen; font-weight: bold; }
    </style>
</head>
<body>
    <h1>URLパラメーターのテスト</h1>
    <p>入力されたパラメーターを JavaScript の <code>simulatedSearchParams</code> で取得しています。</p>

    <div id="output"></div>

    <script>
        // runCode関数で設定されたグローバル変数を使用
        const params = window.simulatedSearchParams;

        if (params) {
            const name = params.get('name') || '名無し';
            const id = params.get('id') || 'IDなし';
            const rawSearch = window.getLocationSearch();

            document.getElementById('output').innerHTML = 
                '<p>パラメーターから取得した値:</p>' +
                '<ul>' +
                '<li>name: <span class="result">' + name + '</span></li>' +
                '<li>id: <span class="result">' + id + '</span></li>' +
                '</ul>' +
                '<p>URL検索文字列全体 (location.search 相当): <span class="result">' + rawSearch + '</span></p>';
        } else {
            document.getElementById('output').textContent = 'パラメーターのシミュレーションに失敗しました。';
        }
    <\/script>
</body>
</html>`;

            document.getElementById('htmlCode').value = initialCode;
            // 初期のコードを一度実行
            runCode();
        };

    </script>
</body>
</html>
